# GIL
**GIL** - это просто логическая переменная (заблокированная), доступ к которой защищен мьютексом (*gil_mutex*), а изменения которой регулируются переменной условия (*gil_cond*). **gil_mutex** используется в течение коротких периодов времени и, следовательно, в основном без ограничений.

В потоке, удерживающем **GIL**, основной цикл (*PyEval_EvalFrameEx*) должен иметь возможность освобождать **GIL** по требованию другого потока. Для этой цели используется изменчивая логическая переменная (*gil_drop_request*), которая проверяется на каждом этапе цикла eval. Эта переменная устанавливается после истечения времени ожидания в микросекундах <u>interval</u> на *gil_cond*.

> Фактически, используется другая изменчивая логическая переменная (*eval_breaker*), которая объединяет несколько условий в одно. Изменчивые логические значения достаточны в качестве средства передачи сигналов между потоками, поскольку Python работает только на архитектурах с согласованным кешем.

Поток, желающий использовать GIL, сначала ожидает заданное количество времени (`interval` микросекунд) перед установкой gil_drop_request. Это способствует определенному периоду переключения, но не обеспечивает его выполнение, поскольку выполнение кодов операций может занять произвольное время.
Значение `interval` доступно для чтения и изменения пользователем с помощью Python API `sys.{get,set}switchinterval()`. 

Когда поток освобождает GIL и установлен gil_drop_request, этот поток гарантирует, что другой поток, ожидающий GIL (GIL-awaiting thread), будет запланирован. Он делает это, ожидая переменной условия (switch_cond), пока значение last_holder не изменится на что-то другое, кроме указателя состояния собственного потока, что указывает на то, что другой поток смог принять GIL. 

Это предназначено для того, чтобы запретить неблагоприятное для задержки поведение на многоядерных машинах, где один поток спекулятивно выпускает GIL, но все равно запускается и в конечном итоге становится первым, кто его повторно получает, что делает «временные интервалы» (timeslices) намного дольше, чем ожидалось. (Примечание: этот механизм включен с помощью FORCE_SWITCHING выше)

----
Ссылки:

- https://github.com/python/cpython/blob/main/Python/ceval_gil.h
- https://github.com/python/cpython/blob/main/Include/internal/pycore_gil.h
- https://realpython.com/python-gil/
